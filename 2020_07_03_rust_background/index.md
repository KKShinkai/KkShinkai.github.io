---
title: "Rust çš„èƒŒæ™¯"
date: "July 3, 2020"
author: "Kk Shinkai"
---

> ğŸš§ è¿˜æ²¡æœ‰å†™å®Œ, è®¡åˆ’è¦å†™ (1) **æ£€æŸ¥æ‚¬å‚æŒ‡é’ˆ**, (2) **RAII, æ‰€æœ‰æƒå’Œæ™ºèƒ½æŒ‡é’ˆ**, (3) **Trait ä¸ç±»å‹ç³»ç»Ÿ** å’Œ (4) **å‡½æ•°å¼ç¨‹åºçš„åŸºç¡€è®¾æ–½** è¿™å‡ éƒ¨åˆ†. ç›®å‰è¿›åº¦ (1/4)

å¾ˆå¤šè½¯ä»¶ç³»ç»Ÿ, åŒ…æ‹¬æ“ä½œç³»ç»Ÿ, é©±åŠ¨ç¨‹åº, æ–‡ä»¶æœåŠ¡å™¨å’Œæ•°æ®åº“, æœ‰éœ€è¦ç»†ç²’åº¦çš„ (fine-grained) æ§åˆ¶æ•°æ®çš„è¡¨ç¤ºå’Œèµ„æºç®¡ç†. ç±»ä¼¼ç³»ç»Ÿæœ€å¸¸ç”¨çš„è¯­è¨€æ˜¯ C, ä½†æ˜¯åœ¨è¿›è¡Œä½çº§ (low-level) æ“ä½œæ—¶, C é»˜è®¸äº†å„å¼å„æ ·çš„å±é™©, å¦‚å¼ºåˆ¶ç±»å‹è½¬æ¢, ç¼“å†²åŒºæº¢ä½, ç©ºæŒ‡é’ˆé”™è¯¯å’Œå†…å­˜æ³„æ¼. æ›´é«˜çº§çš„ (high-level) çš„è¯­è¨€èƒ½é¿å…è¿™äº›å¼Šç«¯, ä½†ä¸æ­¤åŒæ—¶, å®ƒä»¬ä¹Ÿå¾€å¾€æ— æ³•ä¸ºç¨‹åºå‘˜æä¾›å¯¹ä½çº§ç³»ç»Ÿçš„æ§åˆ¶æƒ.

å®é™…ä¸Š, æˆ‘ä»¬å¸Œæœ›æœ‰è¿™æ ·ä¸€é—¨è¯­è¨€, åœ¨ä¿æŒå¯¹èµ„æºç»†ç²’åº¦çš„æ§åˆ¶æ—¶, å…·å¤‡å¦‚ä¸‹æ€§è´¨:

-   ç±»å‹ç³»ç»Ÿæ˜¯å¯é  (sound) çš„, é™æ€ (static) çš„, åœ¨ç¼–è¯‘æœŸæ—¶å€™èƒ½å¤Ÿ (å°½å¯èƒ½çš„) å‘ç°å‹åˆ«é”™è¯¯, ä»¥å¢è¿›æœ€ç»ˆç¨‹åºçš„å¯é æ€§. å¹¶ä¸”ç±»å‹ç³»ç»Ÿåº”è¯¥å°½å¯èƒ½çš„å¼ºå¤§, ä»¥è§£å†³é™æ€ç±»å‹è¯­è¨€çš„çµæ´»æ€§é—®é¢˜.
-   ç¨‹åºæ°¸è¿œä¸ä¼šè§£å¼•ç”¨ (dereference) ä»»ä½•æ‚¬å‚æŒ‡é’ˆ (dangling pointer), è§£å¼•ç”¨æ‚¬å‚æŒ‡é’ˆçš„é”™è¯¯ä¼šåœ¨ç¼–è¯‘æœŸ (compile-time) è¢«æå‡º, è¿è¡Œæ—¶ (run-time) æ—¢ä¸ä¼šä¹Ÿä¸éœ€è¦è¿›è¡Œæ£€æŸ¥.
-   è¯­è¨€æä¾›æ“æ§å¯¹è±¡å¸ƒå±€, æ”¾ç½®ä½ç½®å’Œç”Ÿå‘½å‘¨æœŸ (lifetime) çš„æœºåˆ¶. ç¼–è¯‘å™¨èƒ½ååŠ©ç¨‹åºå‘˜ç®¡ç†å’Œé‡Šæ”¾å†…å­˜, å¯èƒ½å­˜åœ¨å†…å­˜é—®é¢˜æ—¶, ç¼–è¯‘å™¨èƒ½å¤ŸåŠæ—¶å‘ç°å¹¶æŠ¥å‘Šé”™è¯¯.
-   è¯­è¨€æœ¬èº«æ˜¯ç®€å•æ˜“ç”¨çš„, æ‹¥æœ‰å‹å¥½çš„é”™è¯¯æç¤º, å®Œå¤‡çš„æ–‡æ¡£, åŒ…ç®¡ç†å™¨å’Œæ„å»ºå·¥å…·, è‰¯å¥½çš„ (å¸¦ç±»å‹æ¨æ–­çš„) é›†æˆå¼€å‘ç¯å¢ƒç­‰ç­‰.

æ€»ç»“èµ·æ¥ä¾¿æ˜¯ Rust å®˜ç½‘ä¸Šçš„: Performance (é«˜æ€§èƒ½), Reliability (å¯é æ€§) å’Œ Productivity (ç”Ÿäº§åŠ›).

## æ£€æŸ¥æ‚¬å‚æŒ‡é’ˆ

åœ¨ C ä¸­, å±€éƒ¨ (local) å˜é‡æ€»æ˜¯åœ¨æ ˆ (stack) ä¸Šåˆ†é…çš„, è¿›å…¥å’Œç¦»å¼€ä½œç”¨åŸŸä¹Ÿåˆ†åˆ«ä»£è¡¨äº†å˜é‡çš„åˆ†é…å’Œå›æ”¶, ä½œç”¨åŸŸç»“æŸåä¼š, è¯¥å˜é‡å°±ä¸å†å­˜åœ¨. åœ¨ä¸‹ä¾‹ä¸­, 

```c
point_t *run() {
    point_t p = {.x = 1, .y = 2}; // <-- 'p' is valid
    do_something_with(&p);
    return &p; // Address of stack memory associated with local variable
               // 'p' returned
} // <-- 'p' is no longer valid
```

ä½¿ç”¨ `malloc` å‡½æ•°åœ¨å † (heap) ä¸ŠåŠ¨æ€ç”³è¯·çš„å†…å­˜åˆ™ä¸å—ä½œç”¨åŸŸå½±å“, ç›´åˆ°è¢« `free` å‡½æ•°é‡Šæ”¾ (æˆ–ç¨‹åºé€€å‡ºåç”±æ“ä½œç³»ç»Ÿå›æ”¶) ä¸ºæ­¢éƒ½ä¼šä¸€ç›´å­˜åœ¨.

```c
point_t *run() {
    point_t *p = (point_t *)malloc(sizeof(point_t)); // <-- 'p' is valid.
    p->x = 1, p->y = 2;
    do_something_with(p);
    return p;
} // <-- point is still valid
```

æ‰‹å·¥å†…å­˜ç®¡ç† (manual memory management) éå¸¸ç®€å•æ˜“æ‡‚, ä½†åŒæ—¶ä¹Ÿæ„å‘³ç€ç¨‹åºå‘˜å¿…é¡»è®°ä½æ¯ä¸ªå˜é‡çš„ç”Ÿå‘½å‘¨æœŸ, ä½¿ç”¨ä¹‹åæ‰‹åŠ¨é‡Šæ”¾, å¹¶ç¡®è®¤é‡Šæ”¾ä¹‹åä¸å†ä½¿ç”¨. ç”±äºç¨‹åºå¾€å¾€æ˜¯å¾ˆå¤æ‚çš„, å› æ­¤è¿™ç§ç­–ç•¥ä¸å¯é¿å…çš„å¯¼è‡´äº†ä¸å°‘æ— æ•ˆå†…è®¿é—®å’Œå†…å­˜æ³„æ¼çš„é—®é¢˜.

Cyclone æ˜¯ä¸€ä¸ª C çš„ â€œå®‰å…¨ (safe)â€ çš„æ–¹è¨€, åœ¨ Cyclone é‡Œ, å‰ä¸€ä¸ªä¾‹å­ä¸­çš„ C ä»£ç ä¼šè¢«ç±»å‹æ£€æŸ¥å™¨ (type-checker) æ‹’ç». ç¼–è¯‘å™¨ä¼šè¿½è¸ªæŒ‡é’ˆ `p` å’Œå®ƒæŒ‡å‘çš„ç»“æ„ä½“å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ, å¹¶å‘ç°åœ¨å‡½æ•°è¿”å›å, ç»“æ„ä½“å¯¹è±¡å·²ç»è¢«å›æ”¶, ä½† `p` ä»ç„¶å­˜æ´», è¿”å›å€¼å°†ä¼šæˆä¸ºä¸€ä¸ªæ‚¬å‚æŒ‡é’ˆ. è¿™æ ·çš„ä»£ç æ˜¯ä¸è¢«å…è®¸çš„.

Cyclone èƒ½åšåˆ°è¿™äº›, æºäºå®ƒä½¿ç”¨çš„åŸºäºåŒºåŸŸçš„ (region-based) å†…å­˜ç®¡ç†ç­–ç•¥. Cyclone ä¼šç»™æ¯ä¸ªå¯¹è±¡åˆ†é…ä¸€ä¸ªä¸å…¶ç”Ÿå‘½å‘¨æœŸç›¸ç¬¦çš„åŒºåŸŸ (region) æ ‡è¯†ç¬¦, æ¯ä¸ªæŒ‡é’ˆç±»å‹ä¹ŸåŒ…å«ä¸€ä¸ªåŒºåŸŸæ ‡è¯†ç¬¦, å½“æŒ‡é’ˆè¦æŒ‡å‘ä¸€ä¸ªå¯¹è±¡æ—¶, Cyclone ä¼šæ£€æŸ¥äºŒè€…çš„åŒºåŸŸæ˜¯å¦æ˜¯ç›¸å®¹çš„.

```cpp
int f() {
    int x = 0;
    int *@region(`f) y = &x; // <-- `f ä¸ºå‡½æ•° f çš„åŒºåŸŸæ ‡è¯†ç¬¦
    L : {
        int a = 0;
        y = &a; // <-- &a çš„ç±»å‹ä¸º int *@region(`L), ç”±ç¼–è¯‘å™¨æ¨æ–­
    }
    return *y;
}
```

è¿™æ®µä»£ç ä¼šè¢« Cyclone çš„ç¼–è¯‘å™¨æ‹’ç», å› ä¸ºå¯¹è±¡ `a` ç”Ÿå­˜äºåŒºåŸŸ `` `L `` ä¸­, è¿™ä¸ªåŒºåŸŸæ¯” `y` æ‰€åœ¨çš„åŒºåŸŸ `` `f `` è¦å°, å¦‚æœå…è®¸ `y` æŒ‡å‘ `a`, é‚£ä¹ˆå¯¹ `y` è§£å¼•ç”¨å°±å¯èƒ½ä¼šé€ æˆæ‚¬å‚æŒ‡é’ˆé”™è¯¯. é¡ºä¾¿ä¸€æ, Cyclone ä¸­çš„åŒºåŸŸæ ‡è¯†ç¬¦æ˜¯æŒ‡é’ˆç±»å‹çš„ä¸€éƒ¨åˆ†, ç¼–è¯‘å™¨è‡ªåŠ¨æ¨æ–­, æ— éœ€åƒä¸Šæ–‡çš„ä¾‹å­ä¸­é‚£æ ·æ˜¾å¼æ³¨æ˜.

åŒºåŸŸç³»ç»Ÿ (region system) è¿˜æœ‰å¦å¤–ä¸€ä¸ªé‡è¦çš„è®¾æ–½: LIFO åŒºåŸŸ. å®ƒæ”¯æŒå’Œæ ˆç±»ä¼¼çš„ LIFO (last-in-first-out) ç”Ÿå‘½å‘¨æœŸç³»ç»Ÿ, å˜é‡çš„ç”Ÿå‘½å’Œè¯æ³•ä½œç”¨åŸŸç›¸å»åˆ, ä½†åŒæ—¶è¿˜å…è®¸åŠ¨æ€åˆ†é…å†…å­˜.

```cpp
{   region<`r> h;
    ...
}
```

ä¸Šä¾‹çš„è¯­æ³•å£°æ˜äº†ä¸€ä¸ªåŒºåŸŸ `` `r ``, å¹¶å®šä¹‰äº†ä¸€ä¸ªåŒºåŸŸå¥æŸ„ (region handle) `h`, `rmalloc` å’Œ `rnew` å¯ä»¥ä½¿ç”¨è¯¥å¥æŸ„åŠ¨æ€çš„åˆ†é…å†…å­˜.

```cpp
int k(int n) {
    int result;
    {   region<`r> h;
        int ?arr = rnew(h) { for i < n : i };
        result = process(h, arr);
    }
    return result;
}
```

å½“ LIFO åŒºåŸŸ `` `r `` ç»“æŸæ—¶, ä½¿ç”¨å¥æŸ„ `h` åˆ†é…çš„å†…å­˜ä¹Ÿéšä¹‹è¢«å›æ”¶, è¿™æ ·ä¾¿æ— éœ€æ‰‹åŠ¨é‡Šæ”¾, ä¹Ÿä¸ä¼šé€ æˆå†…å­˜æ³„æ¼. äº‹å®ä¸Š, Cyclone æ¯” C å¤šäº†ä¸€ç±»å†…å­˜åŒºåŸŸ, Cyclone çš„å†…å­˜åŒºåŸŸæœ‰ä¸‰ç§ :

-   æ ˆåŒºåŸŸ (stack region) : å±€éƒ¨å®šä¹‰å˜é‡çš„ç”Ÿå‘½å‘¨æœŸå’Œè¯æ³•ä½œç”¨åŸŸç›¸å»åˆ, ä¸ C è¯­è¨€å®Œå…¨ç›¸åŒ.
-   å †åŒºåŸŸ (heap region) : æ°¸ä¹…åŒºåŸŸ `` `H ``, åªèƒ½ä½¿ç”¨ `malloc` æˆ– `new` åœ¨å…¶ä¸Šåˆ†é…ç©ºé—´, ä½†ä¸èƒ½é‡Šæ”¾, æ²¡æœ‰ C è¯­è¨€ä¸­ `free` å‡½æ•°çš„ç±»ä¼¼ç‰©.
-   åŠ¨æ€åŒºåŸŸ (dynamic region) : ä¸´æ—¶åŒºåŸŸ, ä½¿ç”¨ `rmalloc` æˆ– `rnew` è°ƒç”¨åŒºåŸŸå¥æŸ„æ¥åˆ†é…ç©ºé—´, æ— éœ€æ‰‹åŠ¨é‡Šæ”¾, åŒºåŸŸç»“æŸåå†…å­˜è‡ªåŠ¨å›æ”¶.

åˆ°æ­¤ä¸ºæ­¢, æˆ‘ä»¬å·²ç»å¤§ç•¥çš„äº†è§£äº† Cyclone çš„æŒ‡é’ˆè¿½è¸ªæœºåˆ¶, å®é™…ä¸Š, å®ƒå¾ˆåƒä¸€ç§åå˜çš„æ³›å‹ (é•¿å‘¨æœŸè¢«è§†ä¸ºçŸ­å‘¨æœŸçš„å­ç±»å‹) , å€ŸåŠ©ç±»å‹æ¨æ–­å’Œé™æ€æ£€æŸ¥, Cyclone èƒ½å¤Ÿåœ¨ç¼–è¯‘æœŸå‘ç°å¹¶é¢„é˜²æ‚¬å‚æŒ‡é’ˆçš„é”™è¯¯. åœ¨ Rust ä¸­æˆ‘ä»¬ä¹Ÿèƒ½çœ‹è§ Cyclone çš„å½±å­, åœ¨å¦‚ä¸‹çš„ä¾‹å­ä¸­ :

```rust
struct RefPoint {
    x: &i32,
    y: &i32,
}

fn main() {
    let (a, b) = (&1, &2);
    let p = RefPoint { x: a, y: b };

    println!("({}, {})", p.x, p.y);
}
```

ç¼–è¯‘å™¨ä¼šæé†’ä½  :

```
error[E0106]: missing lifetime specifier
 --> src/main.rs:2:8
  |
2 |     x: &i32,
  |        ^ expected named lifetime parameter
```

å› ä¸ºå¼•ç”¨ `x` å’Œ `y` æŒ‡å‘äº† `main` å‡½æ•°çš„ä½œç”¨åŸŸ, åœ¨å£°æ˜ç»“æ„ä½“ `let p = RefPoint { x, y }` æ—¶, å¿…é¡»è¦ç¡®ä¿ `a` å’Œ `b` æ¯” `p` æ´»çš„æ›´ä¹…, å¦åˆ™ä¸€æ—¦ `a` å’Œ `b` æå‰è¢«é‡Šæ”¾, `x` å’Œ `y` å°±å˜æˆäº†æ‚¬å‚æŒ‡é’ˆ.

ä¸ºå…¶å¢åŠ ç”Ÿå‘½å‘¨æœŸæ ‡è®°, ç¼–è¯‘å™¨å°±ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬æ¨æ–­å’Œå¯¹æ¯”å˜é‡çš„å­˜æ´»æ—¶é—´äº†.

```rust
struct RefPoint<'a> {
    x: &'a i32,
    y: &'a i32,
}
```

å¦å¤–, ç‹¬å å‹ (unique) æ™ºèƒ½æŒ‡é’ˆå’Œå¼•ç”¨è®¡æ•°å‹ (reference-counted) æ™ºèƒ½æŒ‡é’ˆåœ¨ Cyclone ä¸­ä¹Ÿæœ‰ç›¸å½“å¹¿æ³›çš„åº”ç”¨, ä½†ç”±äºå‡ ä¹æ²¡æœ‰äººç†Ÿæ‚‰è¿™é—¨è¯­è¨€, å› æ­¤æˆ‘ä¼šåœ¨åæ–‡ä¸­ä¸å†ä»¥å®ƒä¸ºä¾‹.

(æœªå®Œ)

<!-- ## RAII

RAII æ˜¯ C++ çš„è®¾è®¡è€… Bjarne Stroustrup æå‡ºçš„æ¦‚å¿µ, å…¨ç§°æ˜¯ Resource Acquisition is Initialization, è¯‘ä¸ºèµ„æºè·å–å³åˆå§‹åŒ–. èµ„æºçš„ä½¿ç”¨ä¸€èˆ¬åˆ†ä¸ºä¸‰ä¸ªè¿‡ç¨‹: è·å–, ä½¿ç”¨å’Œé”€æ¯. -->

## å‚è€ƒèµ„æ–™

-   [Cyclone: A safe dialect of C](http://www.cs.umd.edu/projects/cyclone/papers/cyclone-safety.pdf)
-   [Cyclone: A Type-Safe Dialect of C](http://www.cs.umd.edu/~mwh/papers/cyclone-cuj.pdf)
-   [Experience With Safe Manual Memory-Management in Cyclone](http://www.cs.umd.edu/~mwh/papers/ismm.pdf)
-   [Introduction to Regions - Cyclone](http://cyclone.thelanguage.org/wiki/Introduction%20to%20Regions/)
-   [Memory management - Wikipedia](https://en.wikipedia.org/wiki/Memory_management#Dynamic_memory_allocation)
-   [RAII - cppreference.com](https://en.cppreference.com/w/cpp/language/raii)
-   [Region-based memory management - Wikipedia](https://en.wikipedia.org/wiki/Region-based_memory_management)
-   [Region-Based Memory Management in Cyclone](http://www.cs.utah.edu/~regehr/reading/open_papers/cyclone_regions.pdf)
-   [Safe Manual Memory Management in Cyclone](http://www.cs.umd.edu/projects/PL/cyclone/scp.pdf)
-   [Safe Systems Programming in Rust: The Promise and the Challenge](https://people.mpi-sws.org/~dreyer/papers/safe-sysprog-rust/paper.pdf)
-   [The Rust Programming Language](https://doc.rust-lang.org/book/)